<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Resultados del Algoritmo Gen√©tico</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <style>
        /* Estilos espec√≠ficos para el modo Cr√©dito (Lista) */
        .results-list { list-style: none; padding: 0; }
        .results-list li {
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 0.95em;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }
        .risk-low { border-left: 5px solid #27ae60; background-color: #e6ffe6; }
        .risk-high { border-left: 5px solid #c0392b; background-color: #ffe6e6; }
        .risk-mid { border-left: 5px solid #f39c12; background-color: #fff8e6; }
        .label { font-weight: bold; margin-right: 5px; color: #34495e; }
        .value { margin-right: 15px; }

        /* Estilos espec√≠ficos para el modo f(x) (Tabla y Gr√°fica) */
        #generation-table th, #generation-table td { text-align: left; padding: 8px; border: 1px solid #ddd; }
        .best-individual-highlight { background-color: #dff0d8 !important; font-weight: bold; }
        #generation-table tbody tr:hover { background-color: #f5f5f5; }
        .chart-container { position: relative; width: 100%; margin: 20px 0; text-align: center; }
    </style>
</head>
<body>
<div class="container">
    <h1>An√°lisis de Resultados del Algoritmo Gen√©tico üìä</h1>

    <th:block th:if="${error}">
        <p class="error-container error-title" th:text="${error}"></p>
    </th:block>

    <th:block th:unless="${error}">
        <div class="results-header" th:if="${generations != null and !generations.isEmpty()}">
            <h2 style="color: white; border-bottom: none;">Resumen de la Ejecuci√≥n</h2>
            <p>Funci√≥n: <span th:text="${functionType}"></span></p>
            <p>Total de Generaciones: <span th:text="${#lists.size(generations)}"></span></p>
            <p th:if="${bestIndividual}">Mejor Fitness Encontrado: <span th:text="${#numbers.formatDecimal(bestIndividual.adaptative, 1, 4)}"></span></p>
        </div>

        <th:block th:if="${isCreditFunction}">
            <div class="generation-info">
                <h2>üèÜ Top 10 Perfiles de Cliente</h2>
                <p>Decodificaci√≥n simple de las variables clave y la conclusi√≥n de riesgo para los individuos m√°s aptos.</p>
            </div>

            <ul class="results-list">
                <th:block th:each="interpretation, index : ${top10Interpretations}">

                    <li th:with="conclusion=${interpretation['Interpretaci√≥n']},
                                      riskClass=
                                        (${#strings.contains(conclusion, 'Riesgo BAJO') or #strings.contains(conclusion, 'Riesgo MUY BAJO')} ? 'risk-low' :
                                        (${#strings.contains(conclusion, 'Riesgo MEDIO')} ? 'risk-mid' : 'risk-high'))"
                        th:class="${riskClass}">

                        <span class="label">#<span th:text="${index.index + 1}"></span>:</span>

                        <th:block th:each="entry : ${interpretation}"
                                  th:if="${entry.key != 'Fitness Total' and entry.key != 'Interpretaci√≥n'}">
                            <span class="label" th:text="${entry.key} + ':'"></span>
                            <span class="value" th:text="${entry.value}"></span>
                        </th:block>

                        <span style="margin-left: auto;">
                                <span class="label">| Fitness:</span>
                                <span class="value" th:text="${interpretation['Fitness Total']}"></span>
                                <span class="label">| Riesgo:</span>
                                <span class="value" th:text="${interpretation['Interpretaci√≥n']}" style="font-weight: bold;"></span>
                            </span>
                    </li>
                </th:block>
            </ul>
        </th:block>

        <th:block th:if="${!isCreditFunction}">
            <div class="generation-info">
                <h3>üìã Par√°metros utilizados</h3>
                <p>
                    <strong>Rango:</strong> [<span th:text="${xmin}"></span>, <span th:text="${xmax}"></span>] |
                    <strong>Precisi√≥n:</strong> <span th:text="${L}"></span> bits |
                    <strong>Total generaciones:</strong> <span th:text="${totalGenerations}"></span>
                </p>
            </div>

            <h2 style="margin-top: 30px;">üìà Convergencia del Algoritmo</h2>
            <p>Gr√°fica del mejor individuo de cada generaci√≥n vs. el valor √≥ptimo esperado.</p>

            <div class="chart-container">
                <img th:src="${chartImage}" alt="Gr√°fica de convergencia del fitness"
                     style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <h2 style="margin-top: 40px;">üß™ Inspecci√≥n Generaci√≥n por Generaci√≥n</h2>
            <p>Navega a trav√©s de las generaciones para ver la evoluci√≥n de los individuos.</p>

            <div id="generation-viewer">

                <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 20px;">

                    <th:block th:if="${currentGeneration > 1}">
                        <a class="nav-button" th:href="@{/results(currentGeneration=${currentGeneration - 1})}">
                            &#9664; Anterior
                        </a>
                    </th:block>
                    <th:block th:if="${currentGeneration <= 1}">
                        <span class="nav-button disabled">&#9664; Anterior</span>
                    </th:block>

                    <span>Generaci√≥n Actual: <strong th:text="${currentGeneration}">1</strong> / <span th:text="${totalGenerations}"></span></span>

                    <th:block th:if="${currentGeneration < totalGenerations}">
                        <a class="nav-button" th:href="@{/results(currentGeneration=${currentGeneration + 1})}">
                            Siguiente &#9658;
                        </a>
                    </th:block>
                    <th:block th:if="${currentGeneration >= totalGenerations}">
                        <span class="nav-button disabled">Siguiente &#9658;</span>
                    </th:block>
                </div>

                <table id="generation-table" style="width: 100%;">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>Cromosoma Binario</th>
                        <th>Valor Decimal</th>
                        <th>Valor Real (x)</th>
                        <th>Aptitud (Fitness)</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="individual, rowStat : ${currentGenIndividuals}"
                        th:classappend="${rowStat.index == 0} ? 'best-individual-highlight'">

                        <td th:text="${rowStat.index + 1}"></td>
                        <td th:text="${individual.binary}"></td>
                        <td th:text="${binaryService.convertBinaryToInt(individual.binary)}"></td>
                        <td th:text="${#numbers.formatDecimal(individual.real, 1, 6)}"></td>
                        <td th:text="${#numbers.formatDecimal(individual.adaptative, 1, 6)}"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </th:block>
    </th:block>

    <p style="text-align: center; margin-top: 30px;"><a href="/" class="back-button">‚Üê Ejecutar nuevo algoritmo</a></p>
</div>
</body>
</html>